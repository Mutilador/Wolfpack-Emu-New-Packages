{$A8,B-,C-,D-,E-,F-,G+,H+,I-,J+,K-,L-,M-,N+,O+,P+,Q-,R-,S-,T-,U-,V+,W-,X+,Y-,Z1}
{$MINSTACKSIZE $00004000}
{$MAXSTACKSIZE $00100000}
{$IMAGEBASE $00400000}
{$APPTYPE GUI}
{$WARN SYMBOL_DEPRECATED ON}
{$WARN SYMBOL_LIBRARY ON}
{$WARN SYMBOL_PLATFORM ON}
{$WARN UNIT_LIBRARY ON}
{$WARN UNIT_PLATFORM ON}
{$WARN UNIT_DEPRECATED ON}
{$WARN HRESULT_COMPAT ON}
{$WARN HIDING_MEMBER ON}
{$WARN HIDDEN_VIRTUAL ON}
{$WARN GARBAGE ON}
{$WARN BOUNDS_ERROR ON}
{$WARN ZERO_NIL_COMPAT ON}
{$WARN STRING_CONST_TRUNCED ON}
{$WARN FOR_LOOP_VAR_VARPAR ON}
{$WARN TYPED_CONST_VARPAR ON}
{$WARN ASG_TO_TYPED_CONST ON}
{$WARN CASE_LABEL_RANGE ON}
{$WARN FOR_VARIABLE ON}
{$WARN CONSTRUCTING_ABSTRACT ON}
{$WARN COMPARISON_FALSE ON}
{$WARN COMPARISON_TRUE ON}
{$WARN COMPARING_SIGNED_UNSIGNED ON}
{$WARN COMBINING_SIGNED_UNSIGNED ON}
{$WARN UNSUPPORTED_CONSTRUCT ON}
{$WARN FILE_OPEN ON}
{$WARN FILE_OPEN_UNITSRC ON}
{$WARN BAD_GLOBAL_SYMBOL ON}
{$WARN DUPLICATE_CTOR_DTOR ON}
{$WARN INVALID_DIRECTIVE ON}
{$WARN PACKAGE_NO_LINK ON}
{$WARN PACKAGED_THREADVAR ON}
{$WARN IMPLICIT_IMPORT ON}
{$WARN HPPEMIT_IGNORED ON}
{$WARN NO_RETVAL ON}
{$WARN USE_BEFORE_DEF ON}
{$WARN FOR_LOOP_VAR_UNDEF ON}
{$WARN UNIT_NAME_MISMATCH ON}
{$WARN NO_CFG_FILE_FOUND ON}
{$WARN MESSAGE_DIRECTIVE ON}
{$WARN IMPLICIT_VARIANTS ON}
{$WARN UNICODE_TO_LOCALE ON}
{$WARN LOCALE_TO_UNICODE ON}
{$WARN IMAGEBASE_MULTIPLE ON}
{$WARN SUSPICIOUS_TYPECAST ON}
{$WARN PRIVATE_PROPACCESSOR ON}
{$WARN UNSAFE_TYPE OFF}
{$WARN UNSAFE_CODE OFF}
{$WARN UNSAFE_CAST OFF}
{$A8,B-,C-,D-,E-,F-,G+,H+,I-,J+,K-,L-,M-,N+,O+,P+,Q-,R-,S-,T-,U-,V+,W-,X+,Y-,Z1}
{$MINSTACKSIZE $00004000}
{$MAXSTACKSIZE $00100000}
{$IMAGEBASE $00400000}
{$APPTYPE GUI}
{$WARN SYMBOL_DEPRECATED ON}
{$WARN SYMBOL_LIBRARY ON}
{$WARN SYMBOL_PLATFORM ON}
{$WARN UNIT_LIBRARY ON}
{$WARN UNIT_PLATFORM ON}
{$WARN UNIT_DEPRECATED ON}
{$WARN HRESULT_COMPAT ON}
{$WARN HIDING_MEMBER ON}
{$WARN HIDDEN_VIRTUAL ON}
{$WARN GARBAGE ON}
{$WARN BOUNDS_ERROR ON}
{$WARN ZERO_NIL_COMPAT ON}
{$WARN STRING_CONST_TRUNCED ON}
{$WARN FOR_LOOP_VAR_VARPAR ON}
{$WARN TYPED_CONST_VARPAR ON}
{$WARN ASG_TO_TYPED_CONST ON}
{$WARN CASE_LABEL_RANGE ON}
{$WARN FOR_VARIABLE ON}
{$WARN CONSTRUCTING_ABSTRACT ON}
{$WARN COMPARISON_FALSE ON}
{$WARN COMPARISON_TRUE ON}
{$WARN COMPARING_SIGNED_UNSIGNED ON}
{$WARN COMBINING_SIGNED_UNSIGNED ON}
{$WARN UNSUPPORTED_CONSTRUCT ON}
{$WARN FILE_OPEN ON}
{$WARN FILE_OPEN_UNITSRC ON}
{$WARN BAD_GLOBAL_SYMBOL ON}
{$WARN DUPLICATE_CTOR_DTOR ON}
{$WARN INVALID_DIRECTIVE ON}
{$WARN PACKAGE_NO_LINK ON}
{$WARN PACKAGED_THREADVAR ON}
{$WARN IMPLICIT_IMPORT ON}
{$WARN HPPEMIT_IGNORED ON}
{$WARN NO_RETVAL ON}
{$WARN USE_BEFORE_DEF ON}
{$WARN FOR_LOOP_VAR_UNDEF ON}
{$WARN UNIT_NAME_MISMATCH ON}
{$WARN NO_CFG_FILE_FOUND ON}
{$WARN MESSAGE_DIRECTIVE ON}
{$WARN IMPLICIT_VARIANTS ON}
{$WARN UNICODE_TO_LOCALE ON}
{$WARN LOCALE_TO_UNICODE ON}
{$WARN IMAGEBASE_MULTIPLE ON}
{$WARN SUSPICIOUS_TYPECAST ON}
{$WARN PRIVATE_PROPACCESSOR ON}
{$WARN UNSAFE_TYPE OFF}
{$WARN UNSAFE_CODE OFF}
{$WARN UNSAFE_CAST OFF}
{$A8,B-,C-,D-,E-,F-,G+,H+,I-,J+,K-,L-,M-,N+,O+,P+,Q-,R-,S-,T-,U-,V+,W-,X+,Y-,Z1}
{$MINSTACKSIZE $00004000}
{$MAXSTACKSIZE $00100000}
{$IMAGEBASE $00400000}
{$APPTYPE GUI}
{$WARN SYMBOL_DEPRECATED ON}
{$WARN SYMBOL_LIBRARY ON}
{$WARN SYMBOL_PLATFORM ON}
{$WARN UNIT_LIBRARY ON}
{$WARN UNIT_PLATFORM ON}
{$WARN UNIT_DEPRECATED ON}
{$WARN HRESULT_COMPAT ON}
{$WARN HIDING_MEMBER ON}
{$WARN HIDDEN_VIRTUAL ON}
{$WARN GARBAGE ON}
{$WARN BOUNDS_ERROR ON}
{$WARN ZERO_NIL_COMPAT ON}
{$WARN STRING_CONST_TRUNCED ON}
{$WARN FOR_LOOP_VAR_VARPAR ON}
{$WARN TYPED_CONST_VARPAR ON}
{$WARN ASG_TO_TYPED_CONST ON}
{$WARN CASE_LABEL_RANGE ON}
{$WARN FOR_VARIABLE ON}
{$WARN CONSTRUCTING_ABSTRACT ON}
{$WARN COMPARISON_FALSE ON}
{$WARN COMPARISON_TRUE ON}
{$WARN COMPARING_SIGNED_UNSIGNED ON}
{$WARN COMBINING_SIGNED_UNSIGNED ON}
{$WARN UNSUPPORTED_CONSTRUCT ON}
{$WARN FILE_OPEN ON}
{$WARN FILE_OPEN_UNITSRC ON}
{$WARN BAD_GLOBAL_SYMBOL ON}
{$WARN DUPLICATE_CTOR_DTOR ON}
{$WARN INVALID_DIRECTIVE ON}
{$WARN PACKAGE_NO_LINK ON}
{$WARN PACKAGED_THREADVAR ON}
{$WARN IMPLICIT_IMPORT ON}
{$WARN HPPEMIT_IGNORED ON}
{$WARN NO_RETVAL ON}
{$WARN USE_BEFORE_DEF ON}
{$WARN FOR_LOOP_VAR_UNDEF ON}
{$WARN UNIT_NAME_MISMATCH ON}
{$WARN NO_CFG_FILE_FOUND ON}
{$WARN MESSAGE_DIRECTIVE ON}
{$WARN IMPLICIT_VARIANTS ON}
{$WARN UNICODE_TO_LOCALE ON}
{$WARN LOCALE_TO_UNICODE ON}
{$WARN IMAGEBASE_MULTIPLE ON}
{$WARN SUSPICIOUS_TYPECAST ON}
{$WARN PRIVATE_PROPACCESSOR ON}
{$WARN UNSAFE_TYPE OFF}
{$WARN UNSAFE_CODE OFF}
{$WARN UNSAFE_CAST OFF}
unit UOStatics;

interface

uses Classes, UOCache;

type TStaticItem = packed record
	Id: Word;
  X: Byte;
  Y: Byte;
  Z: Shortint;
  Hue: Word;
end;

type TStaticBlock = array of TStaticItem;

type TStaticReader = class( TObject )
	private
    Index, Data: TFileStream;
    MapWidth, MapHeight: Word;
    Cache: TCache;
    Disabled: Boolean;
    ModifyTimeData: TDateTime;
    ModifyTimeIndex: TDateTime;

  public
    constructor Create;
    destructor Destroy; override;
    function Open( IndexName: String; DataName: String; MapHeight: Word = 0; MapWidth: Word = 0 ): Boolean;
    procedure Close;
    procedure ReadBlock( XBlock, YBlock: Word; var StaticBlock: TStaticBlock );
    function LastDataModification: TDateTime;
    function LastIndexModification: TDateTime;
end;

implementation

uses SysUtils;

constructor TStaticReader.Create;
begin
  Index := nil;
  Data := nil;
  MapWidth := 0;
  MapHeight := 0;
  Cache := TCache.Create(75);
  Disabled := True;
  ModifyTimeData := Time;
  ModifyTimeIndex := Time;
end;

destructor TStaticReader.Destroy;
begin
	Data.Free;
	Index.Free;
  Cache.Free;
end;

function TStaticReader.Open( IndexName: String; DataName: String; MapHeight: Word = 0; MapWidth: Word = 0 ): Boolean;
begin
  Result := False;

  try
    Index := TFileStream.Create( IndexName, fmOpenRead+fmShareDenyNone );
    Data := TFileStream.Create( DataName, fmOpenRead+fmShareDenyNone );

    if MapHeight = 0 then case Index.Size of
      4718592:
      begin
        MapHeight := 512;
        MapWidth := 768;
      end;

      691200:
      begin
        MapHeight := 200;
        MapWidth := 288;
      end;

      983040:
      begin
        MapWidth := 320;
        MapHeight := 256;
      end;

      393132:
      begin
        MapWidth := 181;
        MapHeight := 181;
      end;
    end;

    if MapHeight = 0 then
      raise Exception.Create( 'Couldn''t determine correct mapsize for TStaticReader' );

    Self.MapHeight := MapHeight;
    Self.MapWidth := MapWidth;

    Disabled := False;
    Result := True;

    // Get modification times
    ModifyTimeData := FileDateToDateTime(FileAge(DataName));
    ModifyTimeIndex := FileDateToDateTime(FileAge(IndexName));
  except
    FreeAndNil(Data);
    FreeAndNil(Index);
  end;
end;

procedure TStaticReader.Close;
begin
	Data.Free;
    Index.Free;

    Data := nil;
    Index := nil;
end;

procedure TStaticReader.ReadBlock( XBlock, YBlock: Word; var StaticBlock: TStaticBlock );
var
	Offset, Length: Cardinal;
  I: Integer;
  BlockId: Cardinal;
  CacheEntry: ^TStaticBlock;
begin
	SetLength( StaticBlock, 0 );

  if Disabled then
    exit;

  BlockId := XBlock * MapHeight + YBlock;

  CacheEntry := Cache.Lookup(BlockId);

  if CacheEntry <> nil then begin
    StaticBlock := CacheEntry^;
    exit;
  end;

	Index.Seek( BlockId * 12, soFromBeginning );
  Index.Read( Offset, 4 );
  Index.Read( Length, 4 );

    if ( Offset = $FFFFFFFF ) or ( Length = 0 ) then
    	exit;

	Data.Seek( Offset, soFromBeginning );

  new(CacheEntry);
  SetLength(CacheEntry^, Length div sizeof( TStaticItem ) );

	for i := 0 to ( Length div sizeof( TStaticItem ) ) - 1 do
		Data.Read( CacheEntry^[i], sizeof( TStaticItem ) );

  Cache.Add(BlockId, CacheEntry);

  StaticBlock := CacheEntry^;
end;

function TStaticReader.LastDataModification: TDateTime;
begin
  Result := ModifyTimeData;
end;

function TStaticReader.LastIndexModification: TDateTime;
begin
  Result := ModifyTimeIndex;
end;

end.
 