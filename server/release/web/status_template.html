<%
import os
import sys
import wolfpack
import wolfpack.sockets
import wolfpack.accounts
import wolfpack.time
import time

#
# Escape a given string for HTML output
#
def escapeString(text):
	text = unicode(text)
	text = text.replace('<', '&lt;')
	text = text.replace('>', '&gt;')
	return text

#
# Count visible sockets
#
playercount = 0
socket = wolfpack.sockets.first()
while socket:
	if socket.player and not socket.player.invisible:
		playercount += 1
	socket = wolfpack.sockets.next()

%>
<?
	function getStatusTime() {
		return <%=int(time.time())%>;
	}
?>
<table width="100%"  border="0" align="center" cellpadding="0" cellspacing="0">
  <tr>
    <td height="16" class="text"><strong>Verbundene Accounts :</strong> <%=playercount%> von <%=wolfpack.accounts.count()%></td>
  </tr>
  <tr>
    <td height="16" class="text"><strong>Spieler Charaktere :</strong> <%=wolfpack.playercount()%></td>
  </tr>
  <tr>
    <td height="16" class="text"><strong>NPCs:</strong> <%=wolfpack.npccount()%></td>
  </tr>
  <tr>
    <td height="16" class="text"><strong>Items:</strong> <%=wolfpack.itemcount()%></td>
  </tr>
  <tr>
    <td height="16" class="text"><strong>Ingame Zeit:</strong> Tag <%=wolfpack.time.days()%>, <%=wolfpack.time.hour()%>:<%="%02u" % wolfpack.time.minute()%></td>
  </tr>
  <tr>
    <td height="16" class="text"><strong>Server Version:</strong> <%=wolfpack.serverversion()%> [Linux]</td>
  </tr>
  <tr>
    <td height="16" class="text"><strong>Server Uptime:</strong> <?
	$server_uptime = floor(<%=wolfpack.currenttime()%> / 1000);

	// Uptime berechnen
	$parts = array();
	if ($server_uptime >= 86400) {
		$value = floor($server_uptime / 86400);
		$server_uptime %= 86400;
		array_push($parts, $value . ' Tage');
	}

        if ($server_uptime >= 3600) {
                $value = floor($server_uptime / 3600);
                $server_uptime %= 3600;
                array_push($parts, $value . ' Stunden');
        }

        if ($server_uptime >= 60) {
                $value = floor($server_uptime / 60);
                $server_uptime %= 60;
                array_push($parts, $value . ' Minuten');
        }

	echo implode(' ', $parts);
?></td>
  </tr>
  <tr>
    <td width="50%" height="16" class="text"><strong>Aktualisiert:</strong> vor <?
    	$diff = time() - getStatusTime();
    	if ($diff < 0) {
    		$diff = 0;
    	}
    	$parts = array();
    	
    	// how much time has passed (check hours)
    	if ($diff >= 3600) {
    		$hours = floor($diff / 3600);
    		$diff = $diff % 3600;
    		array_push($parts, $hours . " Stunden");
    	}
    	
    	// how much time has passed (check minutes)
    	if ($diff >= 60) {
    		$minutes = floor($diff / 60);
    		$diff = $diff % 60;
    		array_push($parts, $minutes . " Minuten");
    	}
    	
    	if ($diff != 0) {
    		array_push($parts, $diff . " Sekunden");
    	}
    	
    	echo implode(' ', $parts);
    ?></td>
  </tr>
  <tr>
    <td height="52" class="text"><br />
      <strong>Verbundene Spieler:</strong><br />
      <table width="97%" height="1" border="0" cellpadding="0" cellspacing="1">
        <%
socket = wolfpack.sockets.first()
while socket:
	if socket.player and not socket.player.invisible:
		%>
        <tr>
          <%
		notoriety = socket.player.notoriety()
		NOTOCOLORS = {
			1: "#811F1E",
			2: "#A99E88",
			3: "#666666",
			4: "#333333",
			5: "#6A533C",
			6: "#2F3240",
		}
		
		BODYIMGS = {
			0x190: '/images/status/gender_male.gif',
			0x191: '/images/status/gender_female.gif',
			0x192: '/images/status/gender_male.gif',
			0x193: '/images/status/gender_female.gif',
		}
		
		print '<td width="16" valign="middle">'
		if BODYIMGS.has_key(socket.player.id):
			print '<div align="center"><img src="%s"></div>' % BODYIMGS[socket.player.id]
		elif socket.player.gender == 0:
			print '<div align="center"><img src="%s"></div>' % BODYIMGS[0x190]
		else:
			print '<div align="center"><img src="%s"></div>' % BODYIMGS[0x191]
		print '</td><td valign="middle" class="text">'
		
		abbrev = ''
		if socket.player.guild:
			abbrev = ' [%s]' % socket.player.guild.abbreviation

		if NOTOCOLORS.has_key(notoriety):
			print '<font color="%s" face="Arial"><b>%s</b>%s</font>' % (NOTOCOLORS[notoriety], escapeString(socket.player.name), escapeString(abbrev))
		else:
			print '<b>%s</b>' % escapeString(socket.player.name)

		if socket.player.region and len(socket.player.region.name) > 0:
			print ' (%s)' % escapeString(socket.player.region.name)
			
		print '</td></tr>'
		%>
        </tr>
        <%
	socket = wolfpack.sockets.next()
%>
      </table></td>
  </tr>
  
  <tr>
    <td height="52"><br />
      <table width="97%" height="1" border="0" cellpadding="0" cellspacing="1">
        <%
guilds = wolfpack.guilds()

if len(guilds) > 0:
	%>
	    <tr bgcolor="#EEE6D2">
			<td class="text"><b>Gilde</b></td> <td class="text"><b>Mitglieder</b></td> <td class="text"><b>Webseite</b></td>
        </tr>
<%

for guild in guilds:
		abbrev = ''
		if len(guild.abbreviation) > 0:
			abbrev = ' [%s]' % guild.abbreviation

		if guild.alignment == 0:
			color = 'black'
		elif guild.alignment == 2:
			color = 'red'
		elif guild.alignment == 1:
			color = 'blue'

		link = ''
		if len(guild.website) > 0 and guild.website.startswith('http://'):
			link = '<a href="%s" target="_blank">Link</a>' % (guild.website)
		elif len(guild.website) > 0:
			link = '<a href="http://%s" target="_blank">Link</a>' % (guild.website)

		%>
        <tr>
			<td width="60%" class="text"><strong><font color="<%=color%>"><%=guild.name%><%=abbrev%></font></strong></td> <td class="text"><%=len(guild.members)%></td> <td class="text"><%=link%></td>
        </tr>
<%
%>
      </table></td>
  </tr>  
  
</table>
